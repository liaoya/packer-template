{
  "builders": [
    {
      "type": "qemu",
      "accelerator": "kvm",
      "format": "qcow2",
      "output_directory": "qemu-{{ user `vm_name` }}",
      "qemuargs": [
        ["-m", "{{ user `memory` }}"],
        ["-smp", "cpus={{ user `cpus` }}"]
      ],
      "vm_name": "{{ user `vm_name` }}.qcow2",
      
      "boot_command": [
        "<up><wait><tab><wait> text ks=http://{{ .HTTPIP }}:{{ .HTTPPort }}/{{ user `kickstart` }}<enter><wait>"
      ],
      "boot_wait": "6s",
      "disk_size": "{{ user `disk_size` }}",
      "headless": "{{ user `headless` }}",
      "http_directory": "http",
      "iso_checksum": "{{user `iso_checksum`}}",
      "iso_checksum_type": "{{user `iso_checksum_type`}}",
      "iso_urls": [
        "{{ user `iso_path` }}/{{ user `iso_name` }}",
        "{{ user `iso_url` }}"
      ],    
      "shutdown_command": "{{user `shutdown_command`}}",
      "ssh_password": "{{user `ssh_password`}}",
      "ssh_username": "{{user `ssh_username`}}",
      "ssh_wait_timeout": "{{user `ssh_wait_timeout`}}"
    },

    {
      "type": "virtualbox-iso",
      "export_opts": [
        "--vsys", "0"
      ],
      "format": "ova",
      "guest_additions_mode": "disable",
      "guest_os_type": "RedHat_64",
      "hard_drive_interface": "sata",
      "output_directory": "virtualbox-{{ user `vm_name` }}",
      "post_shutdown_delay": "10s",
      "vboxmanage": [
        ["modifyvm", "{{.Name}}", "--audio", "none"],
        ["modifyvm", "{{.Name}}", "--cpus", "{{user `cpus`}}"],
        ["modifyvm", "{{.Name}}", "--memory", "{{user `memory`}}"],
        ["modifyvm", "{{.Name}}", "--nictype1", "virtio"],
        ["modifyvm", "{{.Name}}", "--usb", "on", "--usbxhci", "on"]
      ],
      "vm_name": "{{ user `vm_name` }}",

      "boot_command": [
        "<up><wait><tab><wait> text ks=http://{{ .HTTPIP }}:{{ .HTTPPort }}/{{ user `kickstart` }}<enter><wait>"
      ],
      "boot_wait": "6s",
      "disk_size": "{{ user `disk_size` }}",
      "headless": "{{ user `headless` }}",
      "http_directory": "http",
      "iso_checksum": "{{user `iso_checksum`}}",
      "iso_checksum_type": "{{user `iso_checksum_type`}}",
      "iso_urls": [
        "{{ user `iso_path` }}/{{ user `iso_name` }}",
        "{{ user `iso_url` }}"
      ],    
      "shutdown_command": "{{user `shutdown_command`}}",
      "ssh_password": "{{user `ssh_password`}}",
      "ssh_username": "{{user `ssh_username`}}",
      "ssh_wait_timeout": "{{user `ssh_wait_timeout`}}"        
    }
  ],

  "provisioners": [
    {
      "environment_vars": [
        "HTTP_PROXY={{user `http_proxy`}}",
        "NO_PROXY={{user `no_proxy`}}",        
        "http_proxy={{user `http_proxy`}}",
        "https_proxy={{user `https_proxy`}}",
        "no_proxy={{user `no_proxy`}}"
      ],
      "type": "shell",
      "scripts": [
        "scripts/common/sshd.sh",
        "scripts/common/networking.sh",
        "scripts/common/vagrant.sh",
        "scripts/centos/cleanup.sh",
        "scripts/common/minimize.sh"
      ]
    }
  ],

  "post-processors": [
    {
      "environment_vars": ["IMAGENAME={{user `vm_name`}}", "OUTPUT=qemu-{{ user `vm_name` }}", "DEST=images/{{ user `vm_name` }}"],
      "type": "shell-local",
      "only": ["qemu"],
      "inline": [
        "qemu-img amend -f qcow2 -o compat=0.10 $OUTPUT/$IMAGENAME.qcow2",
        "mkdir -p $DEST",
        "xz -c $OUTPUT/$IMAGENAME.qcow2 > $DEST/$IMAGENAME.qcow2.xz"        
      ]
    },

    {
      "environment_vars": ["IMAGENAME={{user `vm_name`}}", "OUTPUT=virtualbox-{{ user `vm_name` }}", "DEST=images/{{ user `vm_name` }}"],
      "type": "shell-local",
      "only": ["virtualbox-iso"],
      "inline": [
        "mkdir -p $DEST",
        "cp $OUTPUT/$IMAGENAME.ova $DEST/$IMAGENAME-virtualbox.ova"
      ]
    },

    {
      "keep_input_artifact": false,
      "output": "box/{{user `vm_name`}}/{{user `vm_name`}}-{{.Provider}}.box",
      "type": "vagrant",
      "vagrantfile_template": "{{ user `vagrantfile_template` }}"
    }
  ],



  "variables": {
    "cpus": "1",
    "disk_size": "20480",
    "http_proxy": "{{env `http_proxy`}}",
    "https_proxy": "{{env `https_proxy`}}",
    "headless": "true",
    "iso_name": "",
    "iso_path": "",
    "iso_url": "",
    "iso_checksum": "",
    "iso_checksum_type": "md5",
    "kickstart": "",
    "memory": "2048",
    "no_proxy": "{{env `no_proxy`}}",

    "shutdown_command": "shutdown -P now",
    "ssh_password": "packer",
    "ssh_username": "root",
    "ssh_wait_timeout": "1200s",
    "vm_name": "CentOS"
  }
}